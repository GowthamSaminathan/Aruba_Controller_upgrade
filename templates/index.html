<!DOCTYPE html>
<html lang="en">
<head>
  <title>Aruba Wireless Upgrade</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.0/css/all.css" crossorigin="anonymous">
  
  


<script src="static/papaparse.min.js"></script>


  
  <link rel="stylesheet" type="text/css" href="static/DataTables/datatables.min.css"/>
 
  <script type="text/javascript" src="static/DataTables/datatables.min.js"></script>

  <style>

.body {

  background-color: #ffffff;
}

.row_selected td {
    background-color: black !important; /* Add !important to make sure override datables base styles */
 }

#p2_device_table {
  counter-reset: row;
  /* Set the row counter to 0 */
}

#p2_device_table tr::before {
  counter-increment: row;
  /* Increment the row counter*/
  content: counter(row) ": ";
  /* Display the row */
}

.navbar_split_line:after {
    content: "|";
    position: absolute;
    top: 16px;
    margin-left: -10px;
}

</style>


</head>

<body overflow-x: hidden;>





<nav class="navbar navbar-expand-md navbar-light bg-light border-dark">
    <a href="#" class="navbar-brand">
        <img src="static/title.png" height="28" alt="CoolBrand" class="navbar_split_line">
    </a>
    
    <h5 class="navbar_split_line_"></h5>
    <h6 style="margin-top: 6px;"><span class="badge badge-light" style="margin-top: 8px; color: #21252994;">Aruba Wireless Upgrade</span></h6>

    <!--<h6 style="margin-top: 12px;"><span class="badge badge-info" id="total_clients">Total Clients : 5</span></h6>-->
    

    &nbsp;&nbsp;&nbsp;
    <div class="btn-group">
  <button type="button" class="btn btn-primary" id="upgrade" onclick="upgrade()">Home</button>
  
  <div class="btn-group">
    <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" id="new_execution">
       Upgrade
    </button>
    <div class="dropdown-menu">
      <a class="dropdown-item" onclick="start_upgrade()">Start Upgrade</a>
      <a class="dropdown-item" onclick="new_execution()">Create New Upgrade POA</a>
      <a class="dropdown-item" href="#">Manage Existing Upgrade POA</a>
    </div>
    <button type="button" class="btn btn-primary" id="history" onclick="show_history()">Upgrade History</button>
  </div>
</div>

    <div class="collapse navbar-collapse" id="navbarCollapse">
       
        <div class="navbar-nav ml-auto">
            <span class="badge badge-danger" id="load-status">Loading...</span>
        </div>
    </div>
</nav>

<br>



<!-- Select upgrade file -  Modal -->
  <div class="modal fade" id="select_upgrade">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title">Start new wireless upgrade</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body">
         
            <div class="container">
            <div class="row" style="margin-right: 0px"> 

            <div class="col-sm-12" style="background-color:#f8f9fa">
        
            <div class="form-group">
            <label for="sel1">Slect POA:</label>
            <select class="form-control" id="job_file_list">
              <option value="none">Please select</option>
            </select>
          </div>
            <div class="custom-control custom-switch">

            <input type="checkbox" class="custom-control-input" id="precheck_only" name="precheck">
            <label class="custom-control-label" for="precheck_only">Precheck only</label>
            </div>



            </div>
          </div>

          <div class="row" style="margin-right: 0px"> 

            <div class="col-sm-12" style="background-color:#f8f9fa">

            <div class="d-flex justify-content-end">
           
            <h6><span class="badge badge-danger" id="start_new_upgrade_badge"></span></h6>
             
            </div>

             <div class="d-flex justify-content-end">

              <button type="button" class="btn btn-warning btn-md" id="start_new_upgrade" onclick="start_new_upgrade()">Start Upgrade</button>
              
             </div>

          </div>
        </div>


          </div>

          

          </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
        
      </div>
    </div>
  </div>



















<div class="container-fluid monitor-col upgrade_class" style="display: none;">


<div class="row" style="margin-right: 0px"> 

<div class="col-sm-6" style="background-color:#f8f9fa">

<button class="btn btn-light" style="width:90%">
  <span class="spinner-border spinner-border-sm"></span>
  Upgrading Controllers 123456 asdasd asdasdasd
</button>

</div>

<div class="col-sm-6" style="background-color:#f8f9fa">
<button type="button" class="btn btn-warning btn-sm">Pause Upgrade</button>
<button type="button" class="btn btn-danger btn-sm">Stop Upgrade</button>
</div>

</div>

<br>

<!-- Table -->
<div class="row" style="margin-right: 0px">
      
      <div class="col-sm-8">
        <table id="execution_table" class="display compact" cellspacing="0"> 
        <tbody id="execution_body"></tbody>
        </table>
      </div>
      
      <div class="col-sm-4">
      <table id="execution_events_table" class="display compact hover" cellspacing="0"> </table>
      </div>
</div>

</div>





<!-- PAGE-2 Starts , ------------------------Creating New Execution form start hear -->


<div class="container new_execution_class" style="display: none;">

<!--<div class="d-flex justify-content-left">
<h5><span class="badge badge-info">Create New Execution</span></h5>
</div>-->

<!-- Upgrade name Row -->

<div class="row" style="margin-right: 0px">  
<div class="col-sm-8">

<form>
  <div class="input-group mb-3 input-group-sm">
     <div class="input-group-prepend">
       <span class="input-group-text">Upgrade Name</span>
    </div>
    <input type="text" class="form-control input-sm" placeholder="Ex: Change CRN20211" id="p2_upgrade_name">

  </div>
</form>

<form>
  <div class="input-group mb-3 input-group-sm">
     <div class="input-group-prepend">
       <span class="input-group-text">AOS Source</span>
    </div>
    <select class="form-control input-sm"  id="p2_upgrade_source">
    <option>local</option>
    <option>tftp</option>
    <option>scp</option>
    <option>ftp</option>
  </select>
   <input type="text" class="form-control" placeholder="Host" id="p2_upgrade_host">
    <input type="text" class="form-control" placeholder="Path" id="p2_upgrade_path">
     <input type="text" class="form-control" placeholder="Username" id="p2_upgrade_uname">
      <input type="password" class="form-control" placeholder="Password" id="p2_upgrade_password">
  </div>
</form>



</div>
</div>





<!-- MM details -->
<h5>MM/MD AOS Details:</h5>
<div class="row" style="margin-right: 0px">
      
<div class="col-sm-12">

<div class="table-responsive">
<table class="table table-striped table-sm">

<thead>

</thead>

<tbody>
<tr>
<td><input type="text" class="form-control input-sm" placeholder="MM AOS Filename" name="mm_aso_file" required="" id="p2_mm_aso_file"></td>
<td><input type="text" class="form-control input-sm" placeholder="Version" name="mm_aso_version" required="" id="p2_mm_aso_version"></td>
<td><input type="text" class="form-control input-sm" placeholder="Build" name="mm_aso_build" required="" id="p2_mm_aso_build"></td>

   
</tr>
</tbody>

</table>
</div>
</div>
</div>


<!-- MD details -->

<div class="row" style="margin-right: 0px">
      
<div class="col-sm-12">

<div class="table-responsive">
<table class="table  table-striped table-sm">

<thead>
<tr id="md_list_table">
</tr>
</thead>

<tbody>
<tr>
<td><input type="text" class="form-control" placeholder="MD AOS Filename" name="md_aso_file" required="" id="p2_md_aso_file"></td>
<td><input type="text" class="form-control" placeholder="Version" name="md_aso_version" required="" id="p2_md_aso_version"></td>
<td><input type="text" class="form-control" placeholder="Build" name="md_aso_build" required="" id="p2_md_aso_build"></td>


</tr>
</tbody>

</table>
</div>
</div>
</div>







<!-- host details -->

<div class="row" style="margin-right: 0px">
      
<div class="col-sm-12">

<div class="table-responsive">
<table class="table table-dark table-striped table-sm" id="p2_upgrade_hosts_list">

<thead>
<tr id="p2_new_host_row">
<th>#</th>
<th>Device</th>
<th>Hostname</th>
<th>Host IP</th>
<th>Custome</th>
<th>Remove/Add </th>
<button type="button" class="btn btn-light btn-sm" id="p2_show_excell_upload" onclick="host_excell_upload()">Upload From Excell</button>
</tr>
</thead>

<tbody >
<tr>
   
</tr>
</tbody>

</table>
</div>
</div>
</div>

<form>
<div class="input-group mb-3 input-group-sm">
   <div class="input-group-prepend">
     <span class="input-group-text">Login Credential: </span>
  </div>
   <input type="text" class="form-control" placeholder="Username" id="p2_hosts_uname">
    <input type="password" class="form-control" placeholder="Password" id="p2_hosts_password">
</div>
</form>

<!-- Save , Modify reset Row -->
<div class="row" style="margin-right: 0px">
      
<div class="col-sm-12">


<div class="d-flex justify-content-center">
  <button type="button" class="btn btn-primary" id="p2_custome_setting_exe" onclick="custome_settings()">Modify Custome Settings</button>&nbsp;&nbsp;&nbsp;
  <button type="button" class="btn btn-warning" id="p2_save_reset" onclick="reset_settings()">Reset</button>&nbsp;&nbsp;&nbsp;
  <button type="button" class="btn btn-success" id="p2_save_all">Save All</button>
</div>
<br>
<br>
</div>



</div></div>


<!-- Page 2 Models start -->


<!-- Save  Modal -->
  <div class="modal fade" id="p2_save_status" id="p2_custome_setting">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header" >
          <h4 class="modal-title" id="p2_save_status_title">Saving Status</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body" id="p2_save_status_body">
           Please wait...
        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
        
      </div>
    </div>
  </div>


<!-- Modify Custome settings Modal -->
  <div class="modal fade" id="p2_custome_setting">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="p2_save_status_title">Modify Custome settings</h4>
          <h4 class="modal-title" id="p2_custome_setting_title"></h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body" id="p2_custome_setting_body">

          <div class="table-responsive">
          <table class="table table-dark table-striped table-sm" >

          <thead>
          <tr>
          <th>Settings</th>
          <th>Status</th>
          <th>Note</th>
          </tr>
          </thead>

          <tbody >
          <tr>
            <td><h6><span class="badge badge-dark">Maximum AP image load: </span></h6></td>
            <td><input type="number" value="500" min="0" max="1000" step="10"/></td>
            <td> </td></tr>

            <tr>
            <td><h6><span class="badge badge-dark">Validate controller sync before upgrade: </span></h6></td>
            <td> <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="switch1" name="example">
            <label class="custom-control-label" for="switch1"></label>
            </div></td>
            <td> </td></tr>

            <tr>
            <td><h6><span class="badge badge-dark">Validate controller up before upgrade: </span></h6></td>
            <td> <div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="switch2" name="example">
            <label class="custom-control-label" for="switch2"></label>
            </div></td>
            <td> </td></tr>

            <td><h6><span class="badge badge-dark">Backup flash before upgrade: </span></h6></td>
            <td><div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="switch3" name="example">
            <label class="custom-control-label" for="switch3"></label>
            </div> </td>
            <td> </td></tr>

            <tr>
            <td><h6><span class="badge badge-dark">Backup configuration before upgrade: </span></h6></td>
            <td><div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="switch4" name="example">
            <label class="custom-control-label" for="switch4"></label>
            </div></td>
            <td> </td></tr>

            <tr>
            <td><h6><span class="badge badge-dark">Backup license before upgrade: </span></h6></td>
            <td><div class="custom-control custom-switch">
            <input type="checkbox" class="custom-control-input" id="switch5" name="example">
            <label class="custom-control-label" for="switch5"></label>
            </div> </td>
            <td> </td></tr>

            <tr>
            <td><h6><span class="badge badge-dark">MM Checklist commands:</span></h6></td>
            <td><div class="form-group">
            
            <textarea class="form-control" rows="5"></textarea>
            </div>
            </td>
            <td>

            </td></tr>

            <tr>
            <td><h6><span class="badge badge-dark">MD Checklist commands:</span></h6></td>
            <td><div class="form-group">
            
            <textarea class="form-control" rows="5"></textarea>
            </div>
            </td>
            <td>

            </td></tr>


          
          </tbody>

          </table>
          </div>
          
          
          
          
          

        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
        
      </div>
    </div>
  </div>



<!-- Edit host settings -->
  <div class="modal fade" id="p2_host_setting">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="p2_host_setting_title">Modify host settings</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body" id="p2_host_setting_body">

        <div class="table-responsive">
        <table class="table table-striped table-sm">
        <thead>
        </thead>
        <tbody>
        <tr>
        <td ><select class="form-control input-sm" id="p2_host_device" data-live-search="true"><option>MM</option><option>MD</option><option>Select Device</option></select></td>
        <td><input type="text" class="form-control input-sm" placeholder="Host name" name="host_name" required="" id="p2_host_hostname"></td>
        <td><input type="text" class="form-control input-sm" placeholder="Host IP" name="host_ip" required="" id="p2_host_hostip"></td>
        </tr>
        </tbody>
        </table>
        </div>

        <div class="table-responsive">
        <table class="table table-striped table-sm">
        <thead>
        </thead>
        <tbody>
        <tr>
        <td><input type="text" class="form-control input-sm" placeholder="AOS Filename" name="p2_host_aso_file" required="" id="p2_host_aso_file"></td>
        <td><input type="text" class="form-control input-sm" placeholder="Version" name="p2_host_aso_version" required="" id="p2_host_aso_version"></td>
        <td><input type="text" class="form-control input-sm" placeholder="Build" name="p2_host_aso_build" required="" id="p2_host_aso_build"></td>
        </tr>
        </tbody>
        </table>
        </div>

        <form>
        <div class="input-group mb-3 input-group-sm">
           <div class="input-group-prepend">
             <span class="input-group-text">Login Credential: </span>
          </div>
           <input type="text" class="form-control" placeholder="Username" id="p2_host_uname">
            <input type="password" class="form-control" placeholder="Password" id="p2_host_password">
        </div>
      </form>

        <!-- <form>
        <div class="input-group mb-3 input-group-sm">
           <div class="input-group-prepend">
             <span class="input-group-text">AOS Source</span>
          </div>
          <select class="form-control input-sm" id="p2_host_upgrade_source">
          <option>local</option>
          <option>tftp</option>
          <option>scp</option>
          <option>ftp</option>
        </select>
         <input type="text" class="form-control" placeholder="Host" id="p2_host_upgrade_host">
          <input type="text" class="form-control" placeholder="Path" id="p2_host_upgrade_path">
           <input type="text" class="form-control" placeholder="Username" id="p2_host_upgrade_uname">
            <input type="password" class="form-control" placeholder="Password" id="p2_host_upgrade_password">
        </div>
      </form> -->

        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
        
      </div>
    </div>
  </div>


<!-- upload Excell host settings -->
  <div class="modal fade" id="p2_excell_upload">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" id="p2_excell_upload_title">Import hosts from Excel</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body" id="p2_excell_upload_body">

          <div class="d-flex flex-row ">
          <div class="p-2"><h5><span class="badge badge-light">Download Excel template: </span></h5>
          </div>
          <div class="p-2"><button type="button" class="btn btn-primary btn-sm"><i class="fa fa-download" aria-hidden="true"></i></button></div>
          </div>

          <div class="d-flex flex-row ">
          <div class="p-2"><h5><span class="badge badge-light">Upload host's from excel:</span></h5></div>
          <div class="p-2">
            
            <input type="file" id="csv_file" name="filename2">
            <div class="mt-2">
            <button type="submit" class="btn btn-primary" onclick="import_from_csv()"> Submit</button>
            </div>

          </div>
          </div>


        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <span class="badge badge-danger" id="csv_import_status">Import failed</span>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
        
      </div>
    </div>
  </div>



<!-- Page-2 End End of New Execution form -->


<!-- Pagge-3 Start : History -->

<div class="container monitor-col report_class">

<!-- Table -->
<div class="row" style="margin-right: 0px">
      
      <div class="col-sm-12">
        <h5><p>Job History</p></h5>
        <div class="table-responsive">
        <table id="history_table" class="table table-striped table-bordered"  style="width:100%"> 
        <tbody id="history_table_body"></tbody>
        </table>
      </div>
      </div>

      <div class="col-sm-6">
        <div id="mymy"></div>
      </div>

</div>

</div>



<!-- Page-3 End : History -->




<script>


//////////////// PAGE -1 START ////////////////////////////////////////////// 

// Init the page-2
var dev_id = 0;
//new_execution();
upgrade();
//show_history();
//$(".report_class").show()
//$(".upgrade_class").hide()
//$(".new_execution_class").hide()

var dataSet = [
    [ 2,"Tiger Nixon", "System Architect", "Edinburgh", "5421", "Pending" ],
    [ 1,"Garrett Winters", "Accountant", "Tokyo", "8422", "Completed"],
    [ 3,"Ashton Cox", "Junior Technical Author", "San Francisco", "1562", "Running"],
    [ 5,"Cedric Kelly", "Senior Javascript Developer", "Edinburgh", "6224", "Completed"],
    [ 4,"Airi Satou", "Accountant", "Tokyo", "5407", "Completed"],
    [ 6,"Brielle Williamson", "Integration Specialist", "New York", "4804", "Completed"],
    [ 7,"Herrod Chandler", "Sales Assistant", "San Francisco", "9608", "Pending"],
    [ 8,"Rhona Davidson", "Integration Specialist", "Tokyo", "6200", "Completed"],
    [ 9,"Colleen Hurst", "Javascript Developer", "San Francisco", "2360", "Paused" ],
    [ 10,"Colleen Hurst", "Javascript Developer", "San Francisco", "2360", "Pending" ],
    [ 12,"Colleen Hurst", "Javascript Developer", "San Francisco", "2360", "Paused" ],
    [ 11,"Colleen Hurst", "Javascript Developer", "San Francisco", "2360", "Failed"]
    
];



// Adding action on creating new row in exection_table
function new_row_action( row, data, dataIndex){
try{

if( data[5] ==  "Running"){
$(row).children('td').slice(5, 6).addClass('bg-primary text-white');
}

if( data[5] ==  "Completed"){
$(row).children('td').slice(5, 6).addClass('bg-success text-white');
}

if( data[5] ==  "Pending"){
$(row).children('td').slice(5, 6).addClass('bg-secondary text-white');
}

if( data[5] ==  "Paused"){
$(row).children('td').slice(5, 6).addClass('bg-warning text-white');
}

if( data[5] ==  "Failed"){
//$(row).addClass('bg-danger text-white');
}

}catch(e){console.log(e);}
}





$(document).ready(function() {
    $('#execution_table').DataTable( {
        "responsive": true,
        "select": true,
        "data": dataSet,
        "columns": [
            { title: "SNo"},
            { title: "Type" },
            { title: "Host" },
            { title: "Version" },
            { title: "Status" },
            { title: "Action" }
        ],
        "columnDefs": [{ "width": "1%", "targets": 0 }
        ],
        "scrollY":        "300px",
        "scrollCollapse": true,
        "paging":         false,
        "createdRow" : new_row_action

} );
});




function modify_execution_table_data( json ) 
{

try{
  console.log("Reding Events response...")
  //console.log(json);
 
   // for ( var i=0, ien=json.length ; i<ien ; i++ ) 
    //{
    //    json[i][0] = '<a href="/message/'+json[i][0]+'>View message</a>';
      
    //}
  only_data = json["data"]
  if (jQuery.isEmptyObject(only_data) == false){
      console.log(only_data);
      jQuery.each(only_data, function(i, val){
      evnt_msg = val[3];
      style_val = 'style="text-align:left;white-space=nowrap"'
      if (evnt_msg.indexOf("ERROR:") == 0)
      {

        val[2] = '<span class="badge badge-danger"'+style_val+'>'+val[2]+'</span>'
         val[3] = '<span class="badge badge-danger"'+style_val+'>'+val[3]+'</span>'

      }else if (evnt_msg.indexOf("INFO:") == 0){

         val[2] = '<span class="badge badge-info"'+style_val+'>'+val[2]+'</span>'
         val[3] = '<span class="badge badge-info"'+style_val+'>'+val[3]+'</span>'


      }else if (evnt_msg.indexOf("WARNING:") == 0){

         val[2] = '<span class="badge badge-warning"'+style_val+'>'+val[2]+'</span>'
         val[3] = '<span class="badge badge-warning"'+style_val+'>'+val[3]+'</span>'

        
      }

      });
      return only_data;

  }
else{
  console.log("Events data not")
  console.log(json);
  return [];
}

}catch(e){console.log("Receiving Events error");return [];}}

$(document).ready(function() {
    events_table = $('#execution_events_table').DataTable( {
        columns: [
            { title: "ID" },
            { title: "NAME" },
            { title: "DATE" },
            { title: "EVENTS" },
            { title: "EID" }

        ],
        "columnDefs": [{ "visible": false, "targets": [0,1,4] }],
        "scrollY":        "400px",
        "scrollCollapse": true,
        "paging":         false,
        //"order": [[ 0, "desc" ]],
        "ajax": {
        "url": "/portal/read_last_events",
        "type": "GET",
        "dataSrc": modify_execution_table_data,
        }
      
      });

} );

//Set error in badge-danger
function server_live_error(xhr, ajaxOptions, thrownError){

$("#load-status").attr('class', 'badge badge-danger');
$("#load-status").text("Server Connection Error");
$("#load-status").fadeOut("fast").fadeIn("fast");


}


//Set Live
function server_live(xhr, ajaxOptions, thrownError){

$("#load-status").attr('class', 'badge badge-success');
$("#load-status").text("Online");
$("#load-status").fadeOut("fast").fadeIn("fast");

}

// Get the server live status
function get_server_status(){

try{

//console.log("Getting server Live status")

$.ajax({
    type: 'GET',url: '/portal/status',contentType: false,cache: false,processData:false,
    success: server_live,error: server_live_error})

}catch(err){console.log("** ==>Error get_server_status: "+err);}}


// Upgrade function
function upgrade(){

$(".report_class").hide()
$(".new_execution_class").hide()
$(".upgrade_class").show()

$("#upgrade").attr('class', 'btn btn-outline-primary active');
$("#new_execution").attr('class', 'btn btn-outline-primary dropdown-toggle');
$("#history").attr('class', 'btn btn-outline-primary');
$(".upgrade_class").show()


}





// Get update execution from server
function get_execution_status(){


update_execution(dataSet);

}


function equalArray(a, b) {
    try{
    //console.log(a)
    //console.log(b)
    return JSON.stringify(a) == JSON.stringify(b);
  }catch(e){console.log(e);}
}


//Update the execution table
function update_execution(device_data){


 if(jQuery.isEmptyObject(device_data) == false){

  var ex_table = $('#execution_table').dataTable();
  
  old_update = equalArray(ex_table.fnGetData(),device_data);
  if(old_update != true) {
    console.log("New execution update from server....")
    ex_table.fnClearTable();
    ex_table.dataTable().fnAddData(device_data);

  }else
  {
    // No new update from server
    //console.log("No new execution update from server")

  }
  
}
}


// Action on selected execution table
function action_select(){

var ex_table = $('#execution_table').dataTable();
selected_data = ex_table.rows('.selected').data();
//console.log(selected_data);

}




function execute_list(odd_even,t_data){
  sno = t_data[0];
  h_type = t_data[1];
  host_name = t_data[2];
  host_ip = t_data[3];
  version = t_data[4];
  status = t_data[5];

  host = host_name +" "+ host_ip

  make_table = (odd_even,t_data) =>
    `
    <tr role="row" class="${odd_even}">
    <td class="sorting_1 dtr-control" id="sno_${sno}">${sno}</td>
    <td id="dtype_${sno}"${h_type}</td>
    <td id="host_${sno}">${host}</td>
    <td id="version_${sno}">${version}</td>
    <td id="status_${sno}">${status}</td>
    <td id="act_${sno}">
    <button class="badge badge-secondary" onclick="exe_action('${sno}')" id="action_${sno}">
    <i class="fas fa-pause"></i>
    </button>
    </td>
    </tr>
    `
  return make_table(odd_even,t_data)
}


//////////////// PAGE -1 END /////////////////////////////////////////////////

//////////////// PAGE -2 START ////////////////////////////////////////////// 


function new_device_list(id_name,t_data){

mm_device = "";
md_device = "";
hostname = "";
hostip = "";

if(t_data["device"] == "MM")
{
mm_device = 'selected="selected"'
}

if(t_data["device"] == "MD")
{
md_device = 'selected="selected"'
}

if(t_data["hostname"] != undefined)
{
hostname = t_data["hostname"]
}

if(t_data["hostip"] != undefined)
{
hostip = t_data["hostip"]
}

console.log(hostip)
console.log("Received:"+id_name)
  make_device_table = (id_name,mm_device,md_device,hostname,hostip) =>
    `

<tr role="row" id="${id_name}_new_device">
<<td ></td>
<td ><select class="form-control input-sm" id="${id_name}_device" data-live-search="true"><option ${mm_device}>MM</option><option ${md_device}>MD</option><option>Select Device</option>MD</select></td>

<td><input value="${hostname}" type="text" class="form-control input-sm" placeholder="Host name" name="host_name" required="" id="${id_name}_hostname"></td>

<td><input value="${hostip}" type="text" class="form-control input-sm" placeholder="Host IP" name="host_ip" required="" id="${id_name}_hostip"></td>
<td><button class="btn btn-primary btn-sm rounded-0" type="button" data-toggle="tooltip" data-placement="top" title="Edit" onclick="host_settings(${id_name})"><i class="fa fa-edit"></i></button></td>
<td><ul class="list-inline m-0">
<li class="list-inline-item">
</li>
<li class="list-inline-item">
<button class="btn btn-danger btn-sm rounded-0" type="button" data-toggle="tooltip" data-placement="top" title="Delete" onclick="delete_device('${id_name}_new_device')"><i class="fa fa-trash"></i></button>
</li>
<button class="btn btn-success btn-sm rounded-0" type="button" data-toggle="tooltip" data-placement="top" title="Add" onclick="add_new_device('${id_name}_new_device','')"><i class="fa fa-plus"></i></button>

</ul></td>

</tr>`

  return make_device_table(id_name,mm_device,md_device,hostname,hostip)
}



function reset_settings(){

console.log("Resetting host settings....")
$("#p2_upgrade_hosts_list").empty();
$("#p2_upgrade_name").val("");

$("#p2_upgrade_host").val("");
$("#p2_upgrade_path").val("");
$("#p2_upgrade_uname").val("");
$("#p2_upgrade_password").val("");

$("#p2_mm_aso_file").val("");
$("#p2_mm_aso_version").val("");
$("#p2_mm_aso_build").val("");

$("#p2_md_aso_file").val("");
$("#p2_md_aso_version").val("");
$("#p2_md_aso_build").val("");

$("#p2_hosts_uname").val("");
$("#p2_hosts_password").val("");

}


function add_data_to_execution_form(data){

// Empty all data


try{

if(data["results"] == "success"){

data = data["data"]
console.log(data);

default_settings = data["default_settings"];
//console.log(default_settings);
Upgrade = data["Upgrade"];

AOS_Source = default_settings["AOS_Source"];
Authentication = default_settings["Authentication"];
MM = default_settings["MM"];
MD = default_settings["MD"];
Validate_Image_before_upgrade = default_settings["Validate_Image_before_upgrade"];
Validate_controller_sync_before_upgrade = default_settings["Validate_controller_sync_before_upgrade"];
Validate_controller_up_before_upgrade = default_settings["Validate_controller_up_before_upgrade"];

// Default AOS source
if(jQuery.isEmptyObject(AOS_Source) == false){
aos_source_device_type = AOS_Source["device_type"];

console.log(aos_source_device_type);

aos_source_local_path = AOS_Source["local_path"];

aos_source_ftp_host = AOS_Source["ftp_host"];
aos_source_ftp_username = AOS_Source["ftp_username"];
aos_source_ftp_password = AOS_Source["ftp_password"];
aos_source_ftp_path = AOS_Source["ftp_path"];

aos_source_scp_host = AOS_Source["scp_host"];
aos_source_scp_username = AOS_Source["scp_username"];
aos_source_scp_password = AOS_Source["scp_password"];
aos_source_scp_path = AOS_Source["scp_path"];

aos_source_tftp_host = AOS_Source["tftp_host"];
aos_source_tftp_path = AOS_Source["tftp_path"];

if(aos_source_device_type == "local")
{
$("#p2_upgrade_source").val("local");
$("#p2_upgrade_path").val(aos_source_local_path);
}

if(aos_source_device_type == "ftp")
{
console.log("OKkkk")
$("#p2_upgrade_source").val("ftp");
$("#p2_upgrade_host").val(aos_source_ftp_host);
$("#p2_upgrade_path").val(aos_source_ftp_path);
$("#p2_upgrade_uname").val(aos_source_ftp_username);
$("#p2_upgrade_password").val(aos_source_ftp_password);
}

if(aos_source_device_type == "scp")
{
$("#p2_upgrade_source").val("scp");
$("#p2_upgrade_host").val(aos_source_scp_host);
$("#p2_upgrade_path").val(aos_source_scp_path);
$("#p2_upgrade_uname").val(aos_source_scp_username);
$("#p2_upgrade_password").val(aos_source_scp_password);
}

if(aos_source_device_type == "tftp")
{
$("#p2_upgrade_source").val("tftp");
$("#p2_upgrade_host").val(aos_source_tftp_host);
$("#p2_upgrade_path").val(aos_source_tftp_path);
}
}


if(jQuery.isEmptyObject(MM) == false)
{

$("#p2_mm_aso_file").val(MM["image_file_name"]);
$("#p2_mm_aso_version").val(MM["image_version"]);
$("#p2_mm_aso_build").val(MM["image_build"]);

}

if(jQuery.isEmptyObject(MD) == false)
{

$("#p2_md_aso_file").val(MD["image_file_name"]);
$("#p2_md_aso_version").val(MD["image_version"]);
$("#p2_md_aso_build").val(MD["image_build"]);

}

if(jQuery.isEmptyObject(Authentication) == false)
{

$("#p2_hosts_uname").val(Authentication["username"]);
$("#p2_hosts_password").val(Authentication["password"]);

}

if(jQuery.isEmptyObject(Authentication) == false)
{

$("#p2_hosts_uname").val(Authentication["username"]);
$("#p2_hosts_password").val(Authentication["password"]);

}

if(jQuery.isEmptyObject(Upgrade) == false)
{

jQuery.each(Upgrade, function(i, val){

hostname = val["hostname"];
device_type = val["device_type"];
host = val["host"];
d ={};
d["device"] = device_type;
d["hostname"] = hostname;
d["hostip"] = host;
if (i == 0){add_new_device(i+1,d);}else{
add_new_device(i+"_new_device",d);}
console.log(d)

});

}

}else{


}

//console.log(data);
$(".upgrade_class").hide();
$(".report_class").hide();
$(".new_execution_class").show();

$("#upgrade").attr('class', 'btn btn-outline-primary');
$("#new_execution").attr('class', 'btn btn-outline-primary active dropdown-toggle');
$("#history").attr('class', 'btn btn-outline-primary');


// Add one new device 


}catch(e){console.log(e);}


}


// Creating new execution 
function new_execution(){

// Reset the page 2 form

console.log("Page-2 init....");
dev_id = 0;

// Reading default template from server
fname_down = "/portal/read_config?config_name=default.yaml"
$(function(){
    $.ajax({
        url: fname_down,
        async: true,   // asynchronous request? (synchronous requests are discouraged...)
        cache: false,   // with this, you can force the browser to not make cache of the retrieved data
        dataType: "json",  // jQuery will infer this, but you can set explicitly
        success: function( data, textStatus, jqXHR ) {
          add_data_to_execution_form(data);
        },
        error(xhr,status,error){
          console.log("read_config error.....");
          console.log(error);
        }
    });
});


}


function delete_device(delete_id){
console.log("Deleting:"+delete_id);
$("#"+delete_id).remove()

}


function add_new_device(caller_id,d){

console.log("Adding new device...");

dev_id = dev_id + 1;


new_dev = new_device_list(dev_id,d);
//console.log(new_dev);
val = caller_id-1

console.log("Adding:"+dev_id+"-After -->"+val);

if(caller_id == 1){
console.log(caller_id-1);
$('#p2_new_host_row').eq(caller_id-1).after(new_dev);

}

else{

$(new_dev).insertAfter("#"+caller_id);

}

console.log("Done...");


}


// Upload host to Excell

function host_excell_upload(){

console.log("showing excell form...")
$("#p2_excell_upload").modal({backdrop: "static"})

}


// Custome setting show

function custome_settings(){

$("#p2_custome_setting").modal({backdrop: "static"})

}


// Custome setting show

function host_settings(host_list_id){

$("#p2_host_setting").modal({backdrop: "static"})

}



function start_upgrade(){

try{

console.log("start_upgrade clicked...")
$("#select_upgrade").modal({backdrop: "static"});

$('#job_file_list').find('option').not(':first').remove();
$('#precheck_only').prop("checked",false);




// Get job name from server

$.ajax({
    type: 'GET',url: '/portal/manage_file',contentType: false,cache: false,processData:false,
    success:function(results){

      status = results["status"]
      current_files = results["current_files"]
      if (jQuery.isEmptyObject(current_files) == false){

      jQuery.each(current_files,function(i, val){

        $('#job_file_list').append('<option value="'+val+'">'+val+'</option>');
      });
    }


    } ,error: function(xhr, ajaxOptions, thrownError){


      console.log("** Getting job files faile for URL : /portal/manage_file");


    }});

}catch(e){console.log("** start_upgrade error");console.log(e);}



}



//////////// PAGE-2 START NEW UPGRADE ///////////////////////////////

function start_new_upgrade(){

job_name = $("#job_file_list").val();
pre_check = $('#precheck_only').prop("checked");

console.log(job_name);
if (job_name == "none"){

$("#start_new_upgrade_badge").attr('class', 'badge badge-danger');
$("#start_new_upgrade_badge").text("Please select the POA");

}else{

$("#start_new_upgrade_badge").attr('class', 'badge badge-info');
$("#start_new_upgrade_badge").text("Please Wait");

if (pre_check == true){job_list=["precheck"];}else{job_list=["all"];}
jdata = {"file_name":job_name,"job_list":job_list}


$.ajax({
    type: 'POST',data:JSON.stringify(jdata),url: '/portal/start_execution',contentType: "application/json",dataType: 'json',    
    success:function(results){
      console.log("Received response for new job execution...");
      console.log(results);
      res_results = results["results"];

      message = results["message"];

      if (res_results == "success"){

        $("#start_new_upgrade_badge").attr('class', 'badge badge-success');
        $("#start_new_upgrade_badge").text(message);


      }else if (res_results == "error"){


        $("#start_new_upgrade_badge").attr('class', 'badge badge-danger');
        $("#start_new_upgrade_badge").text(message);

      }else if (res_results == "failed"){

        $("#start_new_upgrade_badge").attr('class', 'badge badge-danger');
        $("#start_new_upgrade_badge").text(message);

      }


    } ,error: function(xhr, ajaxOptions, thrownError){


      $("#start_new_upgrade_badge").attr('class', 'badge badge-danger');
      $("#start_new_upgrade_badge").text("Failed to reach...");
      console.log("** Starting new job failed....");


    }});


}

}

//////////////// PAGE -2 END ////////////////////////////////////////////// 



//////////////// PAGE -3 START ////////////////////////////////////////////

// Displaing execution history
function show_history(){

console.log("Page-3 init....");
$(".upgrade_class").hide();
$(".new_execution_class").hide();
$(".report_class").show();

$("#upgrade").attr('class', 'btn btn-outline-primary');
$("#new_execution").attr('class', 'btn btn-outline-primary dropdown-toggle');
$("#history").attr('class', 'btn btn-outline-primary active');

}


function modify_history_table_data( json ) 
{

try{
  console.log("Reding history response...")
  //console.log(json);
 
   // for ( var i=0, ien=json.length ; i<ien ; i++ ) 
    //{
    //    json[i][0] = '<a href="/message/'+json[i][0]+'>View message</a>';
      
    //}
  only_data = json["data"]
  if (jQuery.isEmptyObject(only_data) == false){
      console.log(only_data);
      jQuery.each(only_data, function(i, val){
      evnt_msg = val[3];
      style_val = 'style="text-align:left;white-space=nowrap"'
      if (evnt_msg.indexOf("ERROR") == 0)
      {

        //val[0] = '<span class="badge badge-danger"'+style_val+'>'+val[0]+'</span>'
        //val[1] = '<span class="badge badge-danger"'+style_val+'>'+val[1]+'</span>'
        //val[2] = '<span class="badge badge-danger"'+style_val+'>'+val[2]+'</span>'
        val[3] = '<span class="badge badge-danger"'+style_val+'>'+val[3]+'</span>'
         //val[4] = '<span class="badge badge-danger"'+style_val+'>'+val[4]+'</span>'
         //val[5] = '<span class="badge badge-danger"'+style_val+'>'+val[5]+'</span>'
         //val[6] = '<span class="badge badge-danger"'+style_val+'>'+val[6]+'</span>'

      }else if (evnt_msg.indexOf("RUNNING") == 0){

        //val[0] = '<span class="badge badge-warning"'+style_val+'>'+val[0]+'</span>'
        //val[1] = '<span class="badge badge-warning"'+style_val+'>'+val[1]+'</span>'
        //val[2] = '<span class="badge badge-warning"'+style_val+'>'+val[2]+'</span>'
        val[3] = '<span class="badge badge-warning"'+style_val+'>'+val[3]+'</span>'
        // val[4] = '<span class="badge badge-warning"'+style_val+'>'+val[4]+'</span>'
         //val[5] = '<span class="badge badge-warning"'+style_val+'>'+val[5]+'</span>'
         //val[6] = '<span class="badge badge-warning"'+style_val+'>'+val[6]+'</span>'


      }else if (evnt_msg.indexOf("COMPLETED") == 0){

       // val[0] = '<span class="badge badge-success"'+style_val+'>'+val[0]+'</span>'
        //val[1] = '<span class="badge badge-success"'+style_val+'>'+val[1]+'</span>'
        //val[2] = '<span class="badge badge-success"'+style_val+'>'+val[2]+'</span>'
        val[3] = '<span class="badge badge-success"'+style_val+'>'+val[3]+'</span>'
        // val[4] = '<span class="badge badge-success"'+style_val+'>'+val[4]+'</span>'
         //val[5] = '<span class="badge badge-success"'+style_val+'>'+val[5]+'</span>'
         //val[6] = '<span class="badge badge-success"'+style_val+'>'+val[6]+'</span>'

        
      }else{

         //val[0] = '<span class="badge badge-info"'+style_val+'>'+val[0]+'</span>'
        //val[1] = '<span class="badge badge-info"'+style_val+'>'+val[1]+'</span>'
        //val[2] = '<span class="badge badge-info"'+style_val+'>'+val[2]+'</span>'
        val[3] = '<span class="badge badge-info"'+style_val+'>'+val[3]+'</span>'
        // val[4] = '<span class="badge badge-info"'+style_val+'>'+val[4]+'</span>'
         //val[5] = '<span class="badge badge-info"'+style_val+'>'+val[5]+'</span>'
         //val[6] = '<span class="badge badge-info"'+style_val+'>'+val[6]+'</span>'


      }

      });
      return only_data;

  }
else{
  console.log("Job history data not")
  console.log(json);
  return [];
}

}catch(e){console.log("Receiving history error");return [];}}

$(document).ready(function() {
    jobs_table = $('#history_table').DataTable( {
        columns: [
            { title: "ID" },
            { title: "Name" },
            { title: "Configuration" },
            { title: "Status" },
            { title: "Start Date" },
            { title: "Completed Date" },
            { title: "Note" }
        ],
        "scrollY":        "500px",
        "columnDefs": [{ "visible": false, "targets": [1] }],
        "scrollCollapse": true,
        "responsive":true,
        "paging":         false,
        //"order": [[ 0, "desc" ]],
        "ajax": {
        "url": "/portal/read_all_jobs",
        "type": "GET",
        "dataSrc": modify_history_table_data,
        }
      
      });

} );


function import_from_csv()
{
console.log("reading csv....");
csv_file_data = $("#csv_file").prop('files')[0];
console.log(csv_file_data);

Papa.parse(csv_file_data,{
  config: {
    // base config to use for each file
  },
  before: function(file, inputElem)
  {

    $("#csv_import_status").attr('class', 'badge badge-success');
    $("#csv_import_status").text("Uploading...");
    console.log("parsing csv....");
    // executed before parsing each file begins;
    // what you return here controls the flow
  },
  error: function(err, file, inputElem, reason)
  {
    // executed if an error occurs while loading the file,
    // or if before callback aborted for some reason
    $("#csv_import_status").attr('class', 'badge badge-danger');
    $("#csv_import_status").text(reason);
  },
  complete: function(results)
  {
    // executed after all files are complete
    $("#csv_import_status").attr('class', 'badge badge-success');
    $("#csv_import_status").text("Uploaded...");
    console.log(results);
  }
});



}


//////////////// PAGE -3 END ////////////////////////////////////////////




setInterval(get_server_status,3000)
setInterval(get_execution_status,3000)
setInterval( function () {events_table.ajax.reload( null, false );}, 3000 );
setInterval( function () {jobs_table.ajax.reload( null, false );}, 5000 );
</script>



</body>
</html>

